@model IEnumerable<TaskManagementSystem.Models.TaskItem>
@inject TaskManagementSystem.Helpers.PermissionHelper _permissionHelper
@using TaskManagementSystem.Models.Permission
@{
    ViewData["Title"] = "Task";
    var searchText = ViewData["Search"] as string ?? "";
    int sessionUserId = Convert.ToInt32(Context.Session.GetInt32("UserId"));
    string UserName = Convert.ToString(Context.Session.GetString("UserName"));
    var permission = _permissionHelper.GetUserPermissionsForController(sessionUserId, UserName, "Task");
    bool canView = permission?.CanView ?? false;
    bool canCreate = permission?.CanCreate ?? false;
    bool canEdit = permission?.CanEdit ?? false;
    bool canDelete = permission?.CanDelete ?? false;
}

<style>
    .maincontainer {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        padding: 25px;
        border-radius: 12px;
        color: white;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

        .page-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

    .action-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }

    .search-box {
        position: relative;
    }

        .search-box input {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 12px 45px 12px 20px;
            transition: all 0.3s;
            width: 100%;
        }

            .search-box input:focus {
                border-color: #6366f1;
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                outline: none;
            }

        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 1.2rem;
        }

    .btn {
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

    .btn-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }

    .btn-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .alert-danger {
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-left: 4px solid #ef4444;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.1);
    }

    /* Table Styles */
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table {
        margin: 0;
    }

        .table thead th {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            font-weight: 600;
            padding: 15px;
            border: none;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

    .task-image {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.3s;
        cursor: pointer;
    }

        .task-image:hover {
            transform: scale(1.1);
        }

    /* Card View for Mobile */
    .task-card {
        display: none;
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
    }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }

        .task-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .task-card .task-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .task-card .task-date {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .task-card .task-description {
            color: #4b5563;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .task-card .task-image-container {
            text-align: center;
            margin-bottom: 15px;
        }

            .task-card .task-image-container img {
                border-radius: 10px;
                max-width: 100%;
                max-height: 200px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

        .task-card .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

            .task-card .actions .btn {
                flex: 1;
                min-width: 80px;
            }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

        .empty-state i {
            font-size: 4rem;
            color: #d1d5db;
            margin-bottom: 20px;
        }

        .empty-state h4 {
            color: #6b7280;
            font-weight: 600;
        }

        .empty-state p {
            color: #9ca3af;
        }

    /* Stats Badge */
    .stats-badge {
        display: inline-block;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        margin-left: 15px;
    }

    /* Responsive */
    @@media (max-width: 992px) {
        .action-bar .d-flex

    {
        flex-direction: column;
        gap: 15px;
    }

    .search-box {
        order: -1;
    }

    .btn-group {
        display: flex;
        gap: 10px;
    }

        .btn-group .btn {
            flex: 1;
        }

    }

    @@media (max-width: 768px) {
        .maincontainer

    {
        padding: 15px;
    }

    .page-header {
        padding: 20px;
    }

        .page-header h2 {
            font-size: 1.4rem;
        }

    .stats-badge {
        display: block;
        margin-left: 0;
        margin-top: 10px;
        text-align: center;
    }

    .table-container {
        display: none;
    }

    .task-card {
        display: block;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    }

    @@media (max-width: 576px) {
        .page-header h2

    {
        font-size: 1.2rem;
    }

    .action-bar {
        padding: 15px;
    }

    .task-card {
        padding: 15px;
    }

        .task-card .actions .btn {
            font-size: 0.85rem;
        }

    }
</style>

@if (!canView)
{
    <div class="maincontainer">
        <div class="alert alert-danger">
            <i class="bi bi-shield-x"></i> <strong>Access Denied!</strong> You do not have permission to view this page.
        </div>
    </div>
}
else
{
    <div class="maincontainer">
        <!-- Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h2>
                        📋 Task Management
                        <span class="stats-badge">
                            <i class="bi bi-list-check"></i> @Model.Count() Tasks
                        </span>
                    </h2>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group">
                    @if (canCreate)
                    {
                        <a asp-action="Create" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> New Task
                        </a>
                    }
                    <a asp-action="TaskReport" class="btn btn-success"
                       asp-route-search="@searchText">
                        <i class="bi bi-file-earmark-pdf"></i> PDF Report
                    </a>
                </div>

                <!-- Search Box -->
                <div class="search-box" style="flex: 1; max-width: 400px; margin-left: 20px;">
                    <input type="text" id="searchInput" class="form-control"
                           placeholder="🔍 Search tasks by title, description..."
                           value="@searchText" />
                    <i class="bi bi-search search-icon"></i>
                </div>
            </div>
        </div>

        @if (!Model.Any())
        {
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h4>No Tasks Found</h4>
                <p>Start by creating your first task!</p>
                @if (canCreate)
                {
                    <a asp-action="Create" class="btn btn-primary mt-3">
                        <i class="bi bi-plus-circle"></i> Create First Task
                    </a>
                }
            </div>
        }
        else
        {
            <!-- Desktop Table View -->
            <div class="table-container">
                <table class="table table-hover mb-0" id="tasksTable">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Title</th>
                            <th style="width: 35%;">Description</th>
                            <th style="width: 15%;" class="text-center">Image</th>
                            <th style="width: 15%;">Created At</th>
                            @if (canEdit || canDelete || canView)
                            {
                                <th style="width: 15%;" class="text-center">Actions</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var task in Model)
                        {
                            <tr>
                                <td><strong>@task.Title</strong></td>
                                <td>@task.Description</td>
                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(task.ImagePath))
                                    {
                                        <img src="@task.ImagePath" class="task-image"
                                             style="max-width:80px; max-height:80px;"
                                             alt="Task Image" />
                                    }
                                    else
                                    {
                                        <span class="text-muted"><i class="bi bi-image"></i> No image</span>
                                    }
                                </td>
                                <td>
                                    <i class="bi bi-calendar3"></i> @task.CreatedAt.ToString("dd-MMM-yyyy")<br>
                                    <small class="text-muted"><i class="bi bi-clock"></i> @task.CreatedAt.ToString("HH:mm")</small>
                                </td>
                                @if (canEdit || canDelete || canView)
                                {
                                    <td class="text-center">
                                        <div class="d-flex gap-1 justify-content-center flex-wrap">
                                            @if (canView)
                                            {
                                                <a asp-action="Details" asp-route-id="@task.Id" class="btn btn-info btn-sm">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            }
                                            @if (canEdit)
                                            {
                                                <a asp-action="Edit" asp-route-id="@task.Id" class="btn btn-warning btn-sm">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>
                                            }
                                            @if (canDelete)
                                            {
                                                <a asp-action="Delete" asp-route-id="@task.Id" class="btn btn-danger btn-sm"
                                                   onclick="return confirm('Are you sure you want to delete this task?');">
                                                    <i class="bi bi-trash"></i>
                                                </a>
                                            }
                                        </div>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            @foreach (var task in Model)
            {
                <div class="task-card">
                    <div class="card-header">
                        <div style="flex: 1;">
                            <div class="task-title">@task.Title</div>
                            <div class="task-date">
                                <i class="bi bi-calendar3"></i> @task.CreatedAt.ToString("dd MMM yyyy, HH:mm")
                            </div>
                        </div>
                    </div>

                    <div class="task-description">
                        @task.Description
                    </div>

                    @if (!string.IsNullOrEmpty(task.ImagePath))
                    {
                        <div class="task-image-container">
                            <img src="@task.ImagePath" alt="Task Image" />
                        </div>
                    }

                    <div class="actions">
                        @if (canView)
                        {
                            <a asp-action="Details" asp-route-id="@task.Id" class="btn btn-info btn-sm">
                                <i class="bi bi-eye"></i> Details
                            </a>
                        }
                        @if (canEdit)
                        {
                            <a asp-action="Edit" asp-route-id="@task.Id" class="btn btn-warning btn-sm">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                        }
                        @if (canDelete)
                        {
                            <a asp-action="Delete" asp-route-id="@task.Id" class="btn btn-danger btn-sm"
                               onclick="return confirm('Are you sure?');">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        }
                    </div>
                </div>
            }
        }
    </div>
}

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#searchInput').on('keyup', function () {
                var value = $(this).val().toLowerCase();

                // Filter table rows
                $('#tasksTable tbody tr').filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });

                // Filter mobile cards
                $('.task-card').filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });

            // Image preview on click (optional enhancement)
            $('.task-image').on('click', function() {
                var src = $(this).attr('src');
                var modal = '<div class="modal fade" id="imageModal" tabindex="-1">' +
                    '<div class="modal-dialog modal-dialog-centered">' +
                    '<div class="modal-content">' +
                    '<div class="modal-body p-0">' +
                    '<img src="' + src + '" class="img-fluid" />' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';

                $('body').append(modal);
                $('#imageModal').modal('show');
                $('#imageModal').on('hidden.bs.modal', function () {
                    $(this).remove();
                });
            });
        });
    </script>
}
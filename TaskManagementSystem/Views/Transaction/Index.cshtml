@model IEnumerable<TaskManagementSystem.Models.Transaction>
@inject TaskManagementSystem.Helpers.PermissionHelper _permissionHelper
@{
    ViewData["Title"] = "💰 Transaction Report";
    int sessionUserId = Convert.ToInt32(Context.Session.GetInt32("UserId"));
    string UserName = Convert.ToString(Context.Session.GetString("UserName"));
    var permission = _permissionHelper.GetUserPermissionsForController(sessionUserId, UserName, "Transaction");
    bool canView = permission?.CanView ?? false;
    bool canCreate = permission?.CanCreate ?? false;
    bool canEdit = permission?.CanEdit ?? false;
    bool canDelete = permission?.CanDelete ?? false;
}

<style>
    .maincontainer {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px;
        border-radius: 12px;
        color: white;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

        .page-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }

        .filter-card label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        padding: 10px 15px;
        transition: all 0.3s;
    }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

    .btn {
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .btn-info {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }

    /* Table Styles */
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table {
        margin: 0;
    }

        .table thead th {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            font-weight: 600;
            padding: 15px;
            border: none;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
        }

        .table tbody tr:hover {
            background-color: #f8fafc;
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

    .badge-type {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .summary-card {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 20px 25px;
        border-radius: 12px;
        margin-top: 25px;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

        .summary-card .amount {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .summary-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

    /* Pagination */
    .pagination {
        margin-top: 25px;
    }

    .page-link {
        border-radius: 8px;
        margin: 0 3px;
        border: 2px solid #e2e8f0;
        color: #667eea;
        font-weight: 600;
        padding: 8px 16px;
    }

        .page-link:hover {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
        }

    .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }

    /* Responsive Card View for Mobile */
    .transaction-card {
        display: none;
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

        .transaction-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .transaction-card .card-body {
            display: grid;
            gap: 10px;
        }

        .transaction-card .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-card .info-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .transaction-card .info-value {
            font-weight: 600;
            color: #1f2937;
        }

        .transaction-card .actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f1f5f9;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .maincontainer

    {
        padding: 15px;
    }

    .page-header {
        padding: 20px;
    }

        .page-header h2 {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

    .action-buttons {
        width: 100%;
    }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

    .filter-card {
        padding: 20px;
    }

    .table-container {
        display: none;
    }

    .transaction-card {
        display: block;
    }

    .summary-card .amount {
        font-size: 1.6rem;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    }

    @@media (max-width: 576px) {
        .page-header h2

    {
        font-size: 1.2rem;
    }

    .filter-card .col-md-3,
    .filter-card .col-md-2 {
        margin-bottom: 15px;
    }

    .action-buttons .btn {
        font-size: 0.85rem;
        padding: 8px 15px;
    }

    .transaction-card {
        padding: 15px;
    }

    }
</style>

<div class="maincontainer">

    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <h2>💰 Transaction Report</h2>
            <div class="action-buttons">
                @if (canCreate)
                {
                    <a asp-action="Create" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Add Transaction
                    </a>
                }
                <form method="get" asp-action="TransactionReport" class="m-0">
                    <input type="hidden" name="personId" value="@ViewBag.SelectedPersonId" />
                    <input type="hidden" name="month" value="@ViewBag.SelectedMonth" />
                    <input type="hidden" name="from" value="@ViewBag.FromDate" />
                    <input type="hidden" name="to" value="@ViewBag.ToDate" />
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf"></i> PDF Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-card">
        <form id="filterForm" method="get" asp-action="Index" class="row g-3">
            <div class="col-md-3 col-sm-6">
                <label class="form-label">Select Person</label>
                <select name="personId" class="form-select">
                    <option value="">-- All Persons --</option>
                    @if (ViewBag.Persons != null)
                    {
                        int selectedId = ViewBag.SelectedPersonId != null ? Convert.ToInt32(ViewBag.SelectedPersonId) : 0;
                        foreach (var p in (IEnumerable<TaskManagementSystem.Models.Person>)ViewBag.Persons)
                        {
                            bool isSelected = selectedId == p.Id;
                            <option value="@p.Id" selected="@(isSelected ? "selected" : null)">@p.Name</option>
                        }
                    }
                </select>
            </div>

            <div class="col-md-2 col-sm-6">
                <label class="form-label">Select Month</label>
                <input type="month" name="month" class="form-control" value="@ViewBag.SelectedMonth" />
            </div>

            <div class="col-md-2 col-sm-6">
                <label class="form-label">From Date</label>
                <input type="date" name="from" class="form-control" value="@ViewBag.FromDate" />
            </div>

            <div class="col-md-2 col-sm-6">
                <label class="form-label">To Date</label>
                <input type="date" name="to" class="form-control" value="@ViewBag.ToDate" />
            </div>

            <div class="col-md-3 col-12">
                <label class="form-label d-none d-md-block">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success flex-grow-1">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <a asp-action="Index" class="btn btn-secondary flex-grow-1">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Desktop Table View -->
    <div class="table-container">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Person</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th class="text-end">Amount</th>
                    <th>Added By</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <p class="mt-2 mb-0">No transactions found</p>
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Date.ToString("dd-MM-yyyy")</td>
                            <td><strong>@item.Person?.Name</strong></td>
                            <td><span class="badge-type bg-info text-white">@item.Type</span></td>
                            <td>@item.Description</td>
                            <td class="text-end"><strong>@item.Amount.ToString("0.00") ৳</strong></td>
                            <td>@item.CreatedByUserName</td>
                            <td class="text-center">
                                <div class="d-flex gap-1 justify-content-center">
                                    @if (canEdit)
                                    {
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-primary">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                    }
                                    @if (canView)
                                    {
                                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    }
                                    @if (canDelete)
                                    {
                                        <form asp-action="Delete" asp-route-id="@item.Id" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    @if (Model.Any())
    {
        foreach (var item in Model)
        {
            <div class="transaction-card">
                <div class="card-header">
                    <div>
                        <div class="fw-bold text-primary">@item.Person?.Name</div>
                        <small class="text-muted">@item.Date.ToString("dd MMM yyyy")</small>
                    </div>
                    <span class="badge-type bg-info text-white">@item.Type</span>
                </div>
                <div class="card-body">
                    <div class="info-row">
                        <span class="info-label">Description:</span>
                        <span class="info-value">@item.Description</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Amount:</span>
                        <span class="info-value text-success" style="font-size: 1.2rem;">@item.Amount.ToString("0.00") ৳</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Added By:</span>
                        <span class="info-value">@item.CreatedByUserName</span>
                    </div>
                </div>
                <div class="actions">
                    @if (canEdit)
                    {
                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-primary flex-grow-1">
                            <i class="bi bi-pencil-square"></i> Edit
                        </a>
                    }
                    @if (canView)
                    {
                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info flex-grow-1">
                            <i class="bi bi-eye"></i> Details
                        </a>
                    }
                    @if (canDelete)
                    {
                        <form asp-action="Delete" asp-route-id="@item.Id" method="post" class="flex-grow-1" onsubmit="return confirm('Are you sure?');">
                            <button type="submit" class="btn btn-sm btn-danger w-100">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </form>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="transaction-card text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3 mb-0">No transactions found</p>
        </div>
    }

    <!-- Summary Card -->
    <div class="summary-card">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <div class="label">Total Amount</div>
                <h3 class="amount">@ViewBag.TotalAmount.ToString("0.00") ৳</h3>
            </div>
            <i class="bi bi-cash-stack" style="font-size: 3rem; opacity: 0.3;"></i>
        </div>
    </div>

    <!-- Pagination -->
    @if (ViewBag.TotalPages > 1)
    {
        <nav class="mt-4">
            <ul class="pagination justify-content-center flex-wrap">
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Index", new {
                            personId = ViewBag.SelectedPersonId,
                            month = ViewBag.SelectedMonth,
                            from = ViewBag.FromDate,
                            to = ViewBag.ToDate,
                            page = i
                        })">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>